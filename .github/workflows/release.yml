name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., v1.4.0 or 1.4.0)'
        required: true
        default: 'v1.0.0'
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: true
        type: boolean

permissions:
  contents: write  # Need write permission to create releases

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'aa2d37682e3318d93aef87efa7b0e88e81cd3d59'

    - name: Install dependencies
      run: |
        vcpkg install cryptopp:x64-windows
      shell: cmd

    - name: Configure CMake
      run: |
        cmake --preset default
      shell: cmd
      env:
        CMAKE_TOOLCHAIN_FILE: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

    - name: Build Release
      run: |
        cmake --build build --config Release
      shell: cmd

    - name: Get version
      id: get_version
      run: |
        # Use manual input version first
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
          # Ensure version has 'v' prefix
          if (-not $version.StartsWith("v")) {
            $version = "v$version"
          }
        }
        # Get from git tag
        elseif ($env:GITHUB_REF -match 'refs/tags/(.*)') {
          $version = $matches[1]
        }
        # Default fallback
        else {
          $version = "dev-build"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"
      shell: pwsh

    - name: Package artifacts
      run: |
        mkdir release
        copy build\Release\HashCalc.exe release\
        echo "Built on $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" > release\BUILD_INFO.txt
        echo "Version: ${{ steps.get_version.outputs.VERSION }}" >> release\BUILD_INFO.txt
        echo "Commit: ${{ github.sha }}" >> release\BUILD_INFO.txt
      shell: pwsh

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        files: |
          release/HashCalc.exe
          release/BUILD_INFO.txt
        body: |
          ## HashCalc ${{ steps.get_version.outputs.VERSION }}

          ### ðŸ“¦ Downloads
          - **HashCalc.exe** - Windows x64 executable

          ### ðŸ”¨ Build Information
          - Built from commit: ${{ github.sha }}
          - Build date: ${{ github.event.head_commit.timestamp }}

          ### ðŸ“‹ Installation
          1. Download `HashCalc.exe`
          2. Run the executable
          3. No installation required!

          ### ðŸš€ What's New
          See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/README.md#changelog) for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HashCalc-${{ steps.get_version.outputs.VERSION }}
        path: release/
        retention-days: 30
